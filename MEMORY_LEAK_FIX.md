# è¨˜æ†¶é«”æ´©æ¼ä¿®å¾©èªªæ˜

## å•é¡Œè¨ºæ–·

ä½ çš„æ‡‰ç”¨åœ¨é–’ç½®ç‹€æ…‹ä¸‹ä½¿ç”¨ **14.4 GB RAM** æ˜¯éå¸¸ä¸æ­£å¸¸çš„ã€‚ç¶“éæª¢æŸ¥,ç™¼ç¾äº†ä»¥ä¸‹è¨˜æ†¶é«”æ´©æ¼å•é¡Œ:

### 1. ğŸ”´ SearchResultChunk ç„¡é™ç´¯ç©
**å•é¡Œ**: æ¯æ¬¡æœå°‹éƒ½æœƒå»ºç«‹ `SearchResultChunk` è¨˜éŒ„,ä½†å¾æœªæ¸…ç†
- ä½ç½®: `app/models.py` ç¬¬ 111-117 è¡Œ
- å½±éŸ¿: æ¯æ¬¡æœå°‹å¯èƒ½ç”¢ç”Ÿæ•¸ååˆ°æ•¸ç™¾å€‹ chunk,æ¯å€‹åŒ…å«å¤§é‡ JSON è³‡æ–™
- ç´¯ç©æ•ˆæœ: éš¨è‘—ä½¿ç”¨æ™‚é–“å¢é•·,è³‡æ–™åº«å’Œè¨˜æ†¶é«”éƒ½æœƒç„¡é™è†¨è„¹

### 2. ğŸŸ¡ IP_CACHE ç„¡é™å¢é•·
**å•é¡Œ**: IP æŸ¥è©¢å¿«å–æ°¸ä¹…å„²å­˜,æ²’æœ‰å¤§å°é™åˆ¶
- ä½ç½®: `app/utils.py` ç¬¬ 8 è¡Œ
- å½±éŸ¿: æ¯å€‹æ–° IP éƒ½æœƒæ°¸ä¹…å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­
- ç´¯ç©æ•ˆæœ: å¦‚æœæœ‰å¤§é‡ä¸åŒ IP è¨ªå•,è¨˜æ†¶é«”æœƒæŒçºŒå¢é•·

## ä¿®å¾©æ–¹æ¡ˆ

### âœ… ä¿®å¾© 1: SearchResultChunk è‡ªå‹•æ¸…ç†

#### 1.1 æœå°‹å‰æ¸…ç†èˆŠçµæœ
åœ¨ `app/tasks.py` çš„ `search_task` å‡½æ•¸ä¸­(ç¬¬ 85-94 è¡Œ):
```python
# åœ¨å»ºç«‹æ–°çš„æœå°‹çµæœå‰,å…ˆåˆªé™¤è©² task_id çš„èˆŠçµæœ
if task and task.id:
    deleted = SearchResultChunk.query.filter_by(task_id=task.id).delete()
    db.session.commit()
```

#### 1.2 å®šæœŸæ¸…ç†ä»»å‹™
æ–°å¢å®šæœŸä»»å‹™ `cleanup_old_search_results` (æ¯ 30 åˆ†é˜åŸ·è¡Œ):
```python
@huey.periodic_task(crontab(minute='*/30'))
def cleanup_old_search_results():
    # åˆªé™¤ 1 å°æ™‚å‰çš„æœå°‹çµæœ
    cutoff = int(time.time()) - 3600
    SearchResultChunk.query.filter(
        SearchResultChunk.created_at < cutoff
    ).delete()
```

**ç†ç”±**: æœå°‹çµæœæ˜¯æš«æ™‚æ€§çš„,ä½¿ç”¨è€…é€šå¸¸åªæœƒåœ¨æœå°‹å¾ŒçŸ­æ™‚é–“å…§æŸ¥çœ‹,1 å°æ™‚å¾Œå°±å¯ä»¥å®‰å…¨åˆªé™¤ã€‚

### âœ… ä¿®å¾© 2: IP Cache LRU é™åˆ¶

å°‡ `IP_CACHE` å¾æ™®é€šå­—å…¸æ”¹ç‚º `OrderedDict` ä¸¦å¯¦ä½œ LRU (Least Recently Used) æ©Ÿåˆ¶:

```python
from collections import OrderedDict

IP_CACHE = OrderedDict()
IP_CACHE_MAX_SIZE = 1000  # é™åˆ¶æœ€å¤š 1000 å€‹ IP

def get_ip_info(ip):
    if ip in IP_CACHE:
        IP_CACHE.move_to_end(ip)  # æ¨™è¨˜ç‚ºæœ€è¿‘ä½¿ç”¨
        return IP_CACHE[ip]
    
    # ... æŸ¥è©¢é‚è¼¯ ...
    
    IP_CACHE[ip] = info
    
    # å¦‚æœè¶…éé™åˆ¶,ç§»é™¤æœ€èˆŠçš„
    if len(IP_CACHE) > IP_CACHE_MAX_SIZE:
        IP_CACHE.popitem(last=False)
```

**ç†ç”±**: 1000 å€‹ IP è¶³å¤ æ‡‰ä»˜å¤§éƒ¨åˆ†å ´æ™¯,åŒæ™‚é˜²æ­¢ç„¡é™å¢é•·ã€‚

## é æœŸæ•ˆæœ

### è¨˜æ†¶é«”ä½¿ç”¨æ”¹å–„
- **ä¿®å¾©å‰**: 14.4 GB (é–’ç½®ç‹€æ…‹)
- **ä¿®å¾©å¾Œé æœŸ**: 
  - åˆå§‹ç‹€æ…‹: < 500 MB
  - æ­£å¸¸ä½¿ç”¨: 1-2 GB
  - é«˜è² è¼‰: 3-4 GB

### ç‚ºä»€éº¼ä¹‹å‰æœƒé€™éº¼é«˜?
å¦‚æœä½ çš„æ‡‰ç”¨å·²ç¶“é‹è¡Œä¸€æ®µæ™‚é–“:
- å‡è¨­å¹³å‡æ¯å¤© 100 æ¬¡æœå°‹
- æ¯æ¬¡æœå°‹ç”¢ç”Ÿ 20 å€‹ chunks
- æ¯å€‹ chunk ç´„ 50 KB
- é‹è¡Œ 30 å¤© = 100 Ã— 20 Ã— 50 KB Ã— 30 = **3 GB** åƒ…æœå°‹çµæœ

åŠ ä¸Šå…¶ä»–è³‡æ–™å’Œ Python é‹è¡Œæ™‚é–‹éŠ·,14.4 GB æ˜¯å¯èƒ½çš„ã€‚

## éƒ¨ç½²æ­¥é©Ÿ

### 1. é‡å•Ÿæ‡‰ç”¨
```bash
# åœæ­¢ç¾æœ‰æœå‹™
# (æ ¹æ“šä½ çš„éƒ¨ç½²æ–¹å¼,å¯èƒ½æ˜¯ systemctl, docker, æˆ–å…¶ä»–)

# é‡æ–°å•Ÿå‹•
# é€™æœƒè¼‰å…¥æ–°çš„ç¨‹å¼ç¢¼
```

### 2. æ‰‹å‹•æ¸…ç†ç¾æœ‰è³‡æ–™ (å¯é¸)
å¦‚æœæƒ³ç«‹å³é‡‹æ”¾è¨˜æ†¶é«”,å¯ä»¥æ‰‹å‹•æ¸…ç†:

```python
# åœ¨ Python shell ä¸­åŸ·è¡Œ
from app import create_app, db
from app.models import SearchResultChunk

app = create_app()
with app.app_context():
    # åˆªé™¤æ‰€æœ‰èˆŠçš„æœå°‹çµæœ
    count = SearchResultChunk.query.delete()
    db.session.commit()
    print(f"Deleted {count} old search result chunks")
```

### 3. ç›£æ§è¨˜æ†¶é«”
é‡å•Ÿå¾Œ,åœ¨æ•ˆèƒ½ç›£æ§é é¢è§€å¯Ÿè¨˜æ†¶é«”ä½¿ç”¨:
- å‰ 1 å°æ™‚: æ‡‰è©²çœ‹åˆ°è¨˜æ†¶é«”ç©©å®šåœ¨è¼ƒä½æ°´å¹³
- 24 å°æ™‚å¾Œ: è¨˜æ†¶é«”æ‡‰è©²ä¸æœƒæŒçºŒå¢é•·
- å¦‚æœä»æœ‰å•é¡Œ,å¯èƒ½éœ€è¦é€²ä¸€æ­¥èª¿æŸ¥

## å…¶ä»–å»ºè­°

### è³‡æ–™åº«å„ªåŒ–
å¦‚æœè³‡æ–™åº«æª”æ¡ˆå¾ˆå¤§,å¯ä»¥è€ƒæ…®:
```bash
# SQLite VACUUM (å£“ç¸®è³‡æ–™åº«)
sqlite3 instance/app.db "VACUUM;"
```

### ç›£æ§æ”¹é€²
å»ºè­°åœ¨æ•ˆèƒ½ç›£æ§ä¸­åŠ å…¥:
- SearchResultChunk è¡¨çš„è¨˜éŒ„æ•¸
- IP_CACHE çš„å¤§å°
- è³‡æ–™åº«æª”æ¡ˆå¤§å°

## ç¸½çµ

é€™å…©å€‹ä¿®å¾©æ‡‰è©²èƒ½è§£æ±ºå¤§éƒ¨åˆ†è¨˜æ†¶é«”æ´©æ¼å•é¡Œã€‚å¦‚æœé‡å•Ÿå¾Œè¨˜æ†¶é«”ä½¿ç”¨ä»ç„¶ç•°å¸¸é«˜,å¯èƒ½éœ€è¦:
1. æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¤§å‹è³‡æ–™çµæ§‹
2. ä½¿ç”¨ memory_profiler é€²è¡Œè©³ç´°åˆ†æ
3. æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰ç•°å¸¸å¤§çš„è¡¨

---
**ä¿®å¾©æ—¥æœŸ**: 2026-01-23
**å½±éŸ¿ç¯„åœ**: 
- `app/tasks.py` - æ–°å¢æ¸…ç†é‚è¼¯
- `app/utils.py` - IP Cache LRU é™åˆ¶
