<!-- Generic Log Modal -->
<div id="logModal" class="flex items-center justify-center"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: var(--z-modal); pointer-events: none;">
    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5); pointer-events: auto;"
        onclick="closeLogModal()"></div>
    <div class="card"
        style="width: 80%; max-width: 800px; max-height: 80vh; pointer-events: auto; position: relative; z-index: 2002; margin: 0; display: flex; flex-direction: column;">
        <h3 id="logModalTitle" style="margin-bottom: 1rem;">日誌詳情</h3>

        <div
            style="flex:1; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--surface-border);">
            <div id="logModalContent"
                style="white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.85rem; margin: 0; color: #333;">
            </div>
        </div>

        <div class="flex justify-end gap-2" style="margin-top: 1rem;">
            <button type="button" class="btn btn-primary btn-sm" onclick="closeLogModal()">關閉</button>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
    function showLogModal(title, content) {
        document.getElementById('logModalTitle').innerText = title || 'Log Details';
        const contentDiv = document.getElementById('logModalContent');

        let htmlContent = content || 'No content';

        // Try to parse JSON
        try {
            if (content && (content.startsWith('{') || content.startsWith('['))) {
                const json = JSON.parse(content);
                htmlContent = renderJsonTable(json);
            }
        } catch (e) {
            // Not JSON, keep as text
            console.log('Log content is not JSON:', e);
        }

        contentDiv.innerHTML = htmlContent;
        document.getElementById('logModal').style.display = 'flex';
        document.getElementById('logModal').style.pointerEvents = 'auto';
    }

    function renderJsonTable(data) {
        if (typeof data !== 'object' || data === null) return String(data);

        let html = '<table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">';
        for (const key in data) {
            html += `<tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 4px; font-weight: bold; width: 30%; vertical-align: top; color: #555;">${key}</td>
                <td style="padding: 4px; color: #333;">`;

            if (typeof data[key] === 'object' && data[key] !== null) {
                html += renderJsonTable(data[key]); // Recursive
            } else {
                html += String(data[key]);
            }

            html += '</td></tr>';
        }
        html += '</table>';
        return html;
    }

    function closeLogModal() {
        document.getElementById('logModal').style.display = 'none';
    }
</script>