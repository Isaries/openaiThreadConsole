<!-- Project Header & Settings -->
<div class="card">
    <div class="flex items-center justify-between"
        style="padding-bottom: 1rem; border-bottom: 1px solid var(--surface-border); margin-bottom: 1rem;">
        <h2>{{ active_group.name }}</h2>
        <button onclick="toggleSettings()" class="btn btn-secondary btn-sm">âš™ï¸ è¨­å®š</button>
    </div>

    <!-- Settings Panel -->
    <div id="settingsSection"
        style="display:none; background: var(--surface-bg); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
        <form action="/admin/group/update" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="group_id" value="{{ active_group.group_id }}">
            <input type="hidden" name="version" value="{{ active_group.get('version', 1) }}">

            {% if current_role == 'admin' %}
            <!-- Global Auto-Refresh Settings (Admin Only) -->
            <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--surface-border);">
                <h4 style="margin-bottom: 1rem;">ğŸ”„ ç³»çµ±è‡ªå‹•åˆ·æ–°æ’ç¨‹ (Global)</h4>
                <div class="card" style="background: white; border: 1px solid var(--surface-border);">
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>å•Ÿç”¨æ’ç¨‹</label>
                            <div class="flex items-center" style="height: 38px;">
                                <input type="checkbox" id="refresh_enabled" style="width: 1.25rem; height: 1.25rem;" {%
                                    if auto_refresh_settings.get('enabled', True) %}checked{% endif %}>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>åŸ·è¡Œé »ç‡ (å¤©)</label>
                            <input type="number" id="refresh_frequency" class="input" style="width: 120px;" min="1"
                                max="360" value="{{ auto_refresh_settings.get('frequency_days', 3) }}">
                            <span class="text-xs text-secondary" style="margin-left: 4px;">(1-360)</span>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>åŸ·è¡Œæ™‚é–“ (æ¯æ—¥ UTC+8)</label>
                            <select id="refresh_hour" class="select" style="width: 120px;">
                                {% for i in range(24) %}
                                <option value="{{ i }}" {% if auto_refresh_settings.get('hour', 2)==i %}selected{% endif
                                    %}>
                                    {{ "%02d"|format(i) }}:00
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div style="margin-left: auto;">
                            <p class="text-xs text-secondary mb-1">ä¸Šæ¬¡åŸ·è¡Œ: {{ auto_refresh_settings.get('last_run', 'ç„¡ç´€éŒ„')
                                | string | truncate(19, True, '') | replace('T', ' ') }}</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="saveRefreshSettings()">
                                å„²å­˜è¨­å®š
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Auto Refresh History Table -->
            <div style="margin-top: 1.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--surface-border);">
                <h5 style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ğŸ“œ æœ€è¿‘ 5 æ¬¡åŸ·è¡Œç´€éŒ„</h5>
                <div class="card" style="background: white; border: 1px solid var(--surface-border); padding: 0.5rem;">
                    <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #eee; text-align: left;">
                                <th style="padding: 4px;">æ™‚é–“</th>
                                <th style="padding: 4px;">ç‹€æ…‹</th>
                                <th style="padding: 4px;">è€—æ™‚</th>
                                <th style="padding: 4px;">æ›´æ–°/ç¸½æ•¸</th>
                                <th style="padding: 4px;">éŒ¯èª¤</th>
                                <th style="padding: 4px;">è©³æƒ…</th>
                            </tr>
                        </thead>
                        <tbody id="refreshHistoryBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding: 1rem;">è¼‰å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- </div> removed to include rest of form in settingsSection -->

            <script>
                // Auto-correction for Frequency Input
                document.addEventListener('DOMContentLoaded', function () {
                    const freqInput = document.getElementById('refresh_frequency');
                    if (freqInput) {
                        freqInput.addEventListener('blur', function () {
                            let val = parseInt(this.value);
                            if (isNaN(val) || val < 1) {
                                this.value = 1;
                            } else if (val > 360) {
                                this.value = 360;
                            }
                        });
                    }
                    // Load history on load (or when panel opens if we hook it)
                    loadRefreshHistory();
                });

                function loadRefreshHistory() {
                    fetch('/admin/api/refresh_history')
                        .then(r => r.json())
                        .then(resp => {
                            const tbody = document.getElementById('refreshHistoryBody');
                            if (!tbody) return;
                            tbody.innerHTML = '';

                            if (resp.error) {
                                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${resp.error}</td></tr>`;
                                return;
                            }

                            if (!resp.data || resp.data.length === 0) {
                                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999;">å°šç„¡åŸ·è¡Œç´€éŒ„</td></tr>`;
                                return;
                            }

                            resp.data.forEach(item => {
                                let statusColor = 'green';
                                if (item.status === 'Partial') statusColor = 'orange';
                                if (item.status === 'Failed' || item.status === 'Critical Failed') statusColor = 'red';

                                let logsHtml = '-';
                                if (item.logs && item.logs !== '[]') {
                                    logsHtml = `<span title="${item.logs.replace(/"/g, '&quot;')}" style="cursor:help; border-bottom:1px dotted #999;">æŸ¥çœ‹</span>`;
                                }

                                const row = `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 6px;">${item.time}</td>
                                        <td style="padding: 6px;"><span class="badge" style="background:${statusColor}; color:white; padding:2px 6px; font-size:0.75rem;">${item.status}</span></td>
                                        <td style="padding: 6px;">${item.duration}</td>
                                        <td style="padding: 6px;">${item.updated} / ${item.total}</td>
                                        <td style="padding: 6px; color:${item.errors > 0 ? 'red' : 'inherit'}">${item.errors}</td>
                                        <td style="padding: 6px;">${logsHtml}</td>
                                    </tr>
                                `;
                                tbody.insertAdjacentHTML('beforeend', row);
                            });
                        })
                        .catch(e => {
                            console.error(e);
                        });
                }

                function saveRefreshSettings() {
                    const enabled = document.getElementById('refresh_enabled').checked;
                    const frequency = document.getElementById('refresh_frequency').value;
                    const hour = document.getElementById('refresh_hour').value;
                    const csrf = "{{ csrf_token() }}";

                    fetch('/admin/settings/refresh_schedule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrf
                        },
                        body: JSON.stringify({ enabled, frequency, hour })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) alert('è¨­å®šå·²å„²å­˜ï¼');
                            else alert('å„²å­˜å¤±æ•—');
                        })
                        .catch(e => alert('Error: ' + e));
                }
            </script>
            {% endif %}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div>
                    <div class="form-group">
                        <label>Project åç¨±</label>
                        <input type="text" name="name" value="{{ active_group.name }}" required class="input">
                    </div>

                    {% if current_role == 'admin' %}
                    <div class="form-group">
                        <label>æ“æœ‰è€… (Owners)</label>
                        <div
                            style="background: white; border: 1px solid var(--surface-border); padding: 0.5rem; border-radius: var(--radius-md); max-height: 120px; overflow-y: auto;">
                            {% for u in users %}
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                {% set is_self = (u.username == session.get('username')) %}
                                {% set is_checked = u.id in active_group.get('owners', []) or (is_self and
                                current_role == 'admin') %}
                                {% set is_disabled = is_self and current_role == 'admin' %}
                                <input type="checkbox" name="owner_ids" value="{{ u.id }}" id="owner_{{ u.id }}" {% if
                                    is_checked %}checked{% endif %} {% if is_disabled %}disabled{% endif %}>
                                <label for="owner_{{ u.id }}" class="{{ 'text-secondary' if is_disabled else '' }}"
                                    style="margin:0; font-weight: normal; font-size: 0.8rem;">
                                    {{ u.username }}
                                    {% if is_self %}(æ‚¨){% endif %}
                                </label>
                                {% if is_self and current_role == 'admin' %}
                                <!-- Ensure it submits even if disabled -->
                                <input type="hidden" name="owner_ids" value="{{ u.id }}">
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                        <input type="checkbox" name="is_visible" id="is_visible" {% if active_group.get('is_visible',
                            True) %}checked{% endif %} style="width: 1.25rem; height: 1.25rem;">
                        <label for="is_visible" style="margin:0;">é¡¯ç¤ºæ–¼æœå°‹é é¢</label>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label>
                            OpenAI API Key
                            {% if 'é‡‘é‘°å¤±æ•ˆ' in masked_key %}
                            <span class="badge badge-red">å¤±æ•ˆ</span>
                            {% elif masked_key != 'å°šæœªè¨­å®š (ä½¿ç”¨ç’°å¢ƒè®Šæ•¸/é è¨­)' %}
                            <span class="badge badge-green">å·²é€£çµ</span>
                            {% endif %}
                        </label>
                        <div class="flex gap-2">
                            <input type="text" name="api_key" placeholder="è¼¸å…¥æ–° Key ä»¥æ›´æ–°..." class="input">
                            {% if 'å°šæœªè¨­å®š' not in masked_key %}
                            <button type="submit" name="clear_key" value="true" class="btn btn-secondary btn-sm"
                                onclick="return confirm('ç¢ºå®šæ¸…é™¤ï¼Ÿ')">æ¸…é™¤</button>
                            {% endif %}
                        </div>
                        <p class="text-xs text-secondary mt-1">ç›®å‰: <code>{{ masked_key }}</code></p>
                    </div>
                </div>
            </div>

            <!-- Tags Section -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--surface-border);">
                <div class="form-group">
                    <label>Organization</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;"
                        id="tagList_{{ active_group.group_id }}">
                        {% for tag in active_group.tags %}
                        <span class="badge badge-gray" style="display: inline-flex; align-items: center; gap: 4px;">
                            {{ tag }}
                            <button type="button" data-group-id="{{ active_group.group_id }}" data-tag-name="{{ tag }}"
                                onclick="removeTag(this.dataset.groupId, this.dataset.tagName)"
                                style="background: none; border: none; cursor: pointer; color: #666; font-size: 1rem; line-height: 1; padding: 0 2px;">Ã—</button>
                        </span>
                        {% endfor %}
                    </div>

                    <div class="flex gap-2" style="max-width: 300px;">
                        <input type="text" id="newTagInput_{{ active_group.group_id }}" placeholder="æ–°å¢ Organization..."
                            class="input" style="flex:1;" list="availableTags"
                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); addTag('{{ active_group.group_id }}'); return false; }">
                        <button type="button" class="btn btn-secondary btn-sm"
                            onclick="addTag('{{ active_group.group_id }}')">æ–°å¢</button>

                        <datalist id="availableTags">
                            {% for tag in all_tags %}
                            <option value="{{ tag }}">
                                {% endfor %}
                        </datalist>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between"
                style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--surface-border);">
                <button type="submit" formaction="/admin/group/delete" formmethod="POST" class="btn btn-danger btn-sm"
                    onclick="return confirm('âš ï¸ ç¢ºå®šåˆªé™¤ Projectï¼Ÿç„¡æ³•å¾©åŸï¼')">
                    ğŸ—‘ï¸ åˆªé™¤ Project
                </button>
                <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
            </div>
        </form>
    </div>
</div>