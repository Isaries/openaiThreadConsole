<!-- Project Header & Settings -->
<div class="card">
    <div class="flex items-center justify-between"
        style="padding-bottom: 1rem; border-bottom: 1px solid var(--surface-border); margin-bottom: 1rem;">
        <h2>{{ active_group.name }}</h2>
        <button onclick="toggleSettings()" class="btn btn-secondary btn-sm">âš™ï¸ è¨­å®š</button>
    </div>

    <!-- Settings Panel -->
    <div id="settingsSection"
        style="display:none; background: var(--surface-bg); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
        <form action="/admin/group/update" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="group_id" value="{{ active_group.group_id }}">
            <input type="hidden" name="version" value="{{ active_group.get('version', 1) }}">

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div>
                    <div class="form-group">
                        <label>Project åç¨±</label>
                        <input type="text" name="name" value="{{ active_group.name }}" required class="input">
                    </div>

                    {% if current_role == 'admin' %}
                    <div class="form-group">
                        <label>æ“æœ‰è€… (Owners)</label>
                        <div
                            style="background: white; border: 1px solid var(--surface-border); padding: 0.5rem; border-radius: var(--radius-md); max-height: 120px; overflow-y: auto;">
                            {% for u in users %}
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                {% set is_self = (u.username == session.get('username')) %}
                                {% set is_checked = u.id in active_group.get('owners', []) or (is_self and
                                current_role == 'admin') %}
                                {% set is_disabled = is_self and current_role == 'admin' %}
                                <input type="checkbox" name="owner_ids" value="{{ u.id }}" id="owner_{{ u.id }}" {% if
                                    is_checked %}checked{% endif %} {% if is_disabled %}disabled{% endif %}>
                                <label for="owner_{{ u.id }}" class="{{ 'text-secondary' if is_disabled else '' }}"
                                    style="margin:0; font-weight: normal; font-size: 0.8rem;">
                                    {{ u.username }}
                                    {% if is_self %}(æ‚¨){% endif %}
                                </label>
                                {% if is_self and current_role == 'admin' %}
                                <!-- Ensure it submits even if disabled -->
                                <input type="hidden" name="owner_ids" value="{{ u.id }}">
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                        <input type="checkbox" name="is_visible" id="is_visible" {% if active_group.get('is_visible',
                            True) %}checked{% endif %} style="width: 1.25rem; height: 1.25rem;">
                        <label for="is_visible" style="margin:0;">é¡¯ç¤ºæ–¼æœå°‹é é¢</label>
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label>
                            OpenAI API Key
                            {% if 'é‡‘é‘°å¤±æ•ˆ' in masked_key %}
                            <span class="badge badge-red">å¤±æ•ˆ</span>
                            {% elif masked_key != 'å°šæœªè¨­å®š (ä½¿ç”¨ç’°å¢ƒè®Šæ•¸/é è¨­)' %}
                            <span class="badge badge-green">å·²é€£çµ</span>
                            {% endif %}
                        </label>
                        <div class="flex gap-2">
                            <input type="text" name="api_key" placeholder="è¼¸å…¥æ–° Key ä»¥æ›´æ–°..." class="input">
                            {% if 'å°šæœªè¨­å®š' not in masked_key %}
                            <button type="submit" name="clear_key" value="true" class="btn btn-secondary btn-sm"
                                onclick="return confirm('ç¢ºå®šæ¸…é™¤ï¼Ÿ')">æ¸…é™¤</button>
                            {% endif %}
                        </div>
                        <p class="text-xs text-secondary mt-1">ç›®å‰: <code>{{ masked_key }}</code></p>
                    </div>
                </div>
            </div>

            <!-- Tags Section -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--surface-border);">
                <div class="form-group">
                    <label>Project Tag</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;"
                        id="tagList_{{ active_group.group_id }}">
                        {% for tag in active_group.tags %}
                        <span class="badge badge-gray" style="display: inline-flex; align-items: center; gap: 4px;">
                            {{ tag }}
                            <button type="button"
                                onclick="removeTag('{{ active_group.group_id }}', '{{ tag | replace("'", "\\'") }}')"
                                style="background: none; border: none; cursor: pointer; color: #666; font-size: 1rem; line-height: 1; padding: 0 2px;">Ã—</button>
                        </span>
                        {% endfor %}
                    </div>

                    <div class="flex gap-2" style="max-width: 300px;">
                        <input type="text" id="newTagInput_{{ active_group.group_id }}" placeholder="æ–°å¢ Tag..."
                            class="input" style="flex:1;"
                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); addTag('{{ active_group.group_id }}'); return false; }">
                        <button type="button" class="btn btn-secondary btn-sm"
                            onclick="addTag('{{ active_group.group_id }}')">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between"
                style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--surface-border);">
                <button type="submit" formaction="/admin/group/delete" formmethod="POST" class="btn btn-danger btn-sm"
                    onclick="return confirm('âš ï¸ ç¢ºå®šåˆªé™¤ Projectï¼Ÿç„¡æ³•å¾©åŸï¼')">
                    ğŸ—‘ï¸ åˆªé™¤ Project
                </button>
                <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
            </div>
        </form>
    </div>