<!-- Thread List -->
<div class="card">
    <!-- Independent Search Form -->
    <form id="searchForm" action="/admin" method="GET" style="display:none;">
        <input type="hidden" name="group_id" value="{{ active_group.group_id }}">
    </form>

    <form action="/admin/threads/delete_multi" method="POST" id="deleteMultiForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="group_id" value="{{ active_group.group_id }}">

        <!-- Hidden input to toggle 'Select All Across Pages' mode -->
        <input type="hidden" name="select_all_pages" id="selectAllPagesInput" value="false">
        <input type="hidden" name="search_q" value="{{ search_query }}">
    </form>

    <!-- Independent Search Form -->

    <!-- Independent Search Form -->

    <div class="thread-toolbar flex items-center justify-between mb-4" style="margin-bottom: 1rem;">
        <div class="toolbar-header">
            <h3>è³‡æ–™åˆ—è¡¨ <span class="text-secondary text-sm" style="font-weight: normal; font-size: 0.8rem;">(å…±
                    {{ total_threads_count }} ç­†)</span></h3>
        </div>

        <div class="toolbar-actions flex gap-2 items-center">
            <!-- Search Form (GET) -->
            <!-- Search Form Input Group -->
            <div class="search-group"
                style="display: flex; gap: 0; align-items: center; background: white; border: 1px solid var(--surface-border); border-radius: 6px; overflow: hidden; margin-right: 0.5rem; height: 32px;">
                <input form="searchForm" type="text" name="q" placeholder="ğŸ” æœå°‹ ID æˆ–å‚™è¨»..." class="search-input"
                    style="border: none; padding: 0 0.5rem; width: 180px; font-size: 0.875rem; outline: none; height: 100%;"
                    autocomplete="off" value="{{ search_query }}">

                {% if search_query %}
                <a href="{{ url_for('admin.index', group_id=active_group.group_id) }}" title="æ¸…é™¤æœå°‹"
                    style="padding: 0 0.5rem; color: #999; text-decoration: none; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; height: 100%; border-left: 1px solid #eee;">
                    âŒ
                </a>
                {% endif %}

                <button type="submit" form="searchForm" id="searchSubmitBtn" title="é–‹å§‹æœå°‹"
                    style="border: none; background: #f8f9fa; border-left: 1px solid var(--surface-border); cursor: pointer; padding: 0 0.6rem; height: 100%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                    ğŸ”
                </button>
            </div>

            <div class="btn-group">
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/export" formmethod="POST"
                    formtarget="_blank" class="btn btn-secondary btn-sm desktop-only" title="åŒ¯å‡ºå®Œæ•´ Excel (ä¸å—æœå°‹å½±éŸ¿)">
                    ğŸ“¥ åŒ¯å‡º (å®Œæ•´)
                </button>
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/refresh" formmethod="POST"
                    class="btn btn-primary btn-sm" title="æ›´æ–°å¿«å–">
                    ğŸ”„
                    <span class="desktop-only" style="display:inline;">æ›´æ–°</span>
                </button>

                <!-- Mobile Actions are now in Bottom Sheet -->
                <!-- Desktop Delete Button -->
                <button type="submit" form="deleteMultiForm" class="btn btn-danger btn-sm desktop-only"
                    onclick="return confirm('ç¢ºå®šåˆªé™¤é¸å–é …ç›®ï¼Ÿ')">
                    åˆªé™¤é¸å–
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Action Sheet -->
    <div id="bottomActionSheet" class="bottom-action-sheet mobile-only">
        <div class="sheet-content">
            <div class="selected-count">
                <span id="selectedCountDisplay">0</span>
                <span class="text-xs" style="opacity:0.8; margin-left:2px;">ç­†å·²é¸å–</span>
            </div>
            <div class="sheet-actions">
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAllMobile(this)"
                    id="mobileSelectAllBtn">å…¨é¸</button>
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/export" formmethod="POST"
                    formtarget="_blank" class="btn btn-secondary btn-sm" title="åŒ¯å‡º">ğŸ“¥</button>
                <button type="submit" form="deleteMultiForm" class="btn btn-danger btn-sm"
                    onclick="return confirm('ç¢ºå®šåˆªé™¤é¸å–é …ç›®ï¼Ÿ')">
                    ğŸ—‘ï¸ åˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <!-- Smart Select All Banner -->
    <div id="selectAllBanner" data-total="{{ total_threads_count }}" data-page-count="{{ threads|length }}"
        style="display: none; background: #e8f0fe; color: #1967d2; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid #d2e3fc;">
        <span id="selectAllBannerText">å·²é¸å–æœ¬é æ‰€æœ‰é …ç›®ã€‚</span>
        <a href="javascript:void(0)" onclick="selectAllAcrossPages()"
            style="font-weight: bold; text-decoration: underline; margin-left: 8px;">
            é¸å– Project ä¸­çš„å…¨éƒ¨ {{ total_threads_count }} ç­†è³‡æ–™
        </a>
        <span id="allSelectedMsg" style="display: none; font-weight: bold;">å·²é¸å– Project ä¸­çš„å…¨éƒ¨ {{
            total_threads_count
            }} ç­†è³‡æ–™ã€‚</span>
        <a href="javascript:void(0)" id="clearSelectionLink" onclick="clearSelection()"
            style="margin-left: 8px; font-size: 0.9em; display: none;">(æ¸…é™¤é¸å–)</a>

        <div style="margin-top: 4px; font-size: 0.85em; opacity: 0.8;">
            ğŸ’¡ æç¤ºï¼šæ‰¹æ¬¡æ“ä½œå°‡ä½œç”¨æ–¼æ‰€æœ‰ç¬¦åˆç•¶å‰æœå°‹æ¢ä»¶çš„è³‡æ–™ (å«æ‰€æœ‰åˆ†é )ã€‚
        </div>
    </div>

    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="thread-list-table">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="masterCheckbox"
                            onclick="toggleThreadListSelection(this)">
                    </th>
                    <th>Thread ID</th>
                    <th>å‚™è¨»</th>
                    <th style="width: 80px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for thread in threads %}
                <tr>
                    <td><input type="checkbox" form="deleteMultiForm" name="selected_ids" value="{{ thread.thread_id }}"
                            class="thread-checkbox" onclick="checkSelectionState()"></td>
                    <td data-label="Thread ID" class="font-medium text-main">{{ thread.thread_id }}</td>
                    <td data-label="å‚™è¨»" class="editable-remark" data-thread-id="{{ thread.thread_id }}"
                        data-group-id="{{ active_group.group_id }}" style="cursor: pointer;" title="é»æ“Šç·¨è¼¯">
                        {{ thread.remark or 'âœï¸' }}
                    </td>
                    <td data-label="æ“ä½œ">
                        <a href="/admin/threads/view/{{ thread.thread_id }}?group_id={{ active_group.group_id }}"
                            class="btn btn-secondary btn-sm"
                            style="padding: 0.25rem 0.5rem; margin-right: 0.25rem; text-decoration: none;" title="æŸ¥çœ‹å°è©±">
                            ğŸ‘ï¸
                        </a>
                        <button type="submit" form="deleteMultiForm" formaction="/admin/threads/delete_multi"
                            name="thread_id" value="{{ thread.thread_id }}" class="btn btn-danger btn-sm"
                            style="padding: 0.25rem 0.5rem;" onclick="return confirm('åˆªé™¤ï¼Ÿ')">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        æ²’æœ‰è³‡æ–™
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    {% if threads_pagination and threads_pagination.pages > 1 %}
    <div class="flex items-center justify-between"
        style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-border);">
        <div class="text-sm text-secondary">
            é¡¯ç¤º {{ threads_pagination.items|length }} ç­† (å…± {{ total_threads_count }} ç­†)
        </div>
        <div class="flex gap-1" style="display:flex; gap:0.5rem;">
            {% if threads_pagination.has_prev %}
            <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.prev_num, q=search_query if search_query else None) }}"
                class="btn btn-secondary btn-sm">â€¹ ä¸Šä¸€é </a>
            {% endif %}

            <span class="btn btn-sm" style="background: transparent; border: 1px solid transparent; cursor: default;">
                é æ¬¡ {{ threads_pagination.page }} / {{ threads_pagination.pages }}
            </span>

            {% if threads_pagination.has_next %}
            <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.next_num, q=search_query if search_query else None) }}"
                class="btn btn-secondary btn-sm">ä¸‹ä¸€é  â€º</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    </form>

    <script>
        function toggleThreadListSelection(source) {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
            checkSelectionState(); // Unified state check
        }

        function toggleAllMobile(btn) {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            // Logic: If any is unchecked, check all. If all checked, uncheck all.
            let anyUnchecked = false;
            for (let c of checkboxes) { if (!c.checked) anyUnchecked = true; }

            const newState = anyUnchecked; // True means "Select All", False means "Deselect All"

            for (let c of checkboxes) { c.checked = newState; }

            const master = document.getElementById('masterCheckbox');
            if (master) master.checked = newState;

            checkSelectionState(); // Unified state check
        }

        function checkSelectionState() {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            let checkedCount = 0;
            let allChecked = true;

            if (checkboxes.length === 0) allChecked = false;

            for (let c of checkboxes) {
                if (c.checked) {
                    checkedCount++;
                } else {
                    allChecked = false;
                }
            }

            // Master Checkbox Sync
            const master = document.getElementById('masterCheckbox');
            if (master) master.checked = allChecked;

            // Update Bottom Sheet
            const sheet = document.getElementById('bottomActionSheet');
            const countDisplay = document.getElementById('selectedCountDisplay');
            const mobileSelectBtn = document.getElementById('mobileSelectAllBtn');

            if (sheet && countDisplay) {
                countDisplay.textContent = checkedCount;
                if (checkedCount > 0) {
                    sheet.classList.add('active');
                } else {
                    sheet.classList.remove('active');
                }
            }

            // Update Mobile Select Button Text
            if (mobileSelectBtn) {
                mobileSelectBtn.textContent = allChecked ? "å–æ¶ˆå…¨é¸" : "å…¨é¸";
            }

            // Banner Logic
            handleBannerVisibility(allChecked);
        }

        function handleBannerVisibility(isAllPageChecked) {
            const banner = document.getElementById('selectAllBanner');
            // Get data from DOM attributes to avoid Jinja/JS syntax conflict
            const total = parseInt(banner.dataset.total) || 0;
            const onPage = parseInt(banner.dataset.pageCount) || 0;

            // Only show banner if there are more items than currently visible
            if (isAllPageChecked && total > onPage) {
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
                clearSelection();
            }
        }

        function selectAllAcrossPages() {
            document.getElementById('selectAllPagesInput').value = 'true';
            document.getElementById('selectAllBannerText').style.display = 'none';

            document.querySelector('#selectAllBanner a[onclick^="selectAllAcrossPages"]').style.display = 'none';
            document.getElementById('allSelectedMsg').style.display = 'inline';
            document.getElementById('clearSelectionLink').style.display = 'inline';
        }

        function clearSelection() {
            document.getElementById('selectAllPagesInput').value = 'false';
            document.getElementById('selectAllBannerText').style.display = 'inline';
            const link = document.querySelector('#selectAllBanner a[onclick^="selectAllAcrossPages"]');
            if (link) link.style.display = 'inline';
            document.getElementById('allSelectedMsg').style.display = 'none';
            document.getElementById('clearSelectionLink').style.display = 'none';
        }

        // Search Loading UX
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('searchForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    // Show Floating Toast
                    const toast = document.createElement('div');
                    toast.id = 'searchLoadingToast';
                    toast.innerHTML = `
                        <span>ğŸ” æ­£åœ¨æœå°‹...</span>
                        <button type="button" id="cancelSearchBtn" style="background:none; border:none; color:white; cursor:pointer; font-size:1.1em; opacity:0.8; padding:0 4px; display:flex; align-items:center;">âœ•</button>
                    `;
                    Object.assign(toast.style, {
                        position: 'fixed',
                        top: '20px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        background: 'rgba(33, 150, 243, 0.95)',
                        color: 'white',
                        padding: '0.75rem 1.25rem',
                        paddingRight: '0.75rem',
                        borderRadius: '50px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        zIndex: '9999',
                        fontWeight: '500',
                        fontSize: '0.95rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                    });
                    document.body.appendChild(toast);

                    // Update Button State
                    const btn = document.getElementById('searchSubmitBtn');
                    if (btn) {
                        btn.innerHTML = 'â³';
                        btn.style.cursor = 'wait';
                        btn.style.background = '#eee';
                    }

                    // Handle Cancel
                    document.getElementById('cancelSearchBtn').onclick = function () {
                        window.stop(); // Stop navigation
                        document.body.removeChild(toast);
                        if (btn) {
                            btn.innerHTML = 'ğŸ”';
                            btn.style.cursor = 'pointer';
                            btn.style.background = '#f8f9fa';
                        }
                    };
                });
            }
        });
    </script>
</div>