<!-- Thread List -->
<div class="card">
    <!-- Independent Search Form -->
    <form id="searchForm" action="{{ url_for('admin.index') }}" method="GET" style="display:none;">
        <input type="hidden" name="group_id" value="{{ active_group.group_id }}">
    </form>

    <form action="/admin/threads/delete_multi" method="POST" id="deleteMultiForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="group_id" value="{{ active_group.group_id }}">

        <!-- Hidden input to toggle 'Select All Across Pages' mode -->
        <input type="hidden" name="select_all_pages" id="selectAllPagesInput" value="false">
        <input type="hidden" name="search_q" value="{{ search_query }}">
        <input type="hidden" name="status_filter" value="{{ status_filter }}">
    </form>

    <!-- Independent Search Form -->

    <!-- Independent Search Form -->

    <div class="thread-toolbar flex items-center justify-between mb-4" style="margin-bottom: 1rem;">
        <div class="toolbar-header">
            <h3>è³‡æ–™åˆ—è¡¨ <span class="text-secondary text-sm" style="font-weight: normal; font-size: 0.8rem;">(å…±
                    {{ total_threads_count }} ç­†)</span>

                <!-- Moved Status Legend -->
                <div class="status-legend-wrapper" style="margin-left: 0.5rem; vertical-align: middle;">
                    <span class="status-legend-icon"
                        style="cursor: help; opacity: 0.6; display: inline-flex; vertical-align: text-bottom;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </span>
                    <div class="status-legend-tooltip" style="width: 300px; bottom: auto; top: 100%; margin-top: 10px;">
                        <div class="status-legend-item">
                            <strong>ğŸŸ¢ æ´»èº Active</strong>
                            <span>æ­£å¸¸æ›´æ–°ï¼Œç³»çµ±æœƒå®šæœŸæª¢æŸ¥æ–°å…§å®¹ã€‚</span>
                        </div>
                        <div class="status-legend-item">
                            <strong>ğŸŸ¡ ä½å„ªå…ˆ Low Priority</strong>
                            <span>é•·æ™‚é–“ç„¡è®ŠåŒ–ï¼Œç³»çµ±å°‡é™ä½æª¢æŸ¥é »ç‡ã€‚</span>
                        </div>
                        <div class="status-legend-item">
                            <strong>ğŸ”´ å‡çµ Frozen</strong>
                            <span>å·²åœæ­¢è‡ªå‹•æ›´æ–°ï¼Œè‹¥éœ€æ¢å¾©è«‹æ‰‹å‹•æ›´æ–°ä¸€æ¬¡ã€‚</span>
                        </div>
                    </div>
                </div>
            </h3>
        </div>

        <div class="toolbar-actions flex gap-2 items-center">
            <!-- Search Form (GET) -->
            <!-- Search Form Input Group -->
            <div class="search-group"
                style="display: flex; gap: 0; align-items: center; background: white; border: 1px solid var(--surface-border); border-radius: 6px; overflow: hidden; margin-right: 0.5rem; height: 32px;">

                <!-- Status Filter Dropdown -->
                <select form="searchForm" name="status_filter" onchange="this.form.submit()"
                    style="border: none; border-right: 1px solid #eee; background: #f8f9fa; padding: 0 0.5rem; height: 100%; font-size: 0.875rem; color: var(--text-main); cursor: pointer; outline: none;">
                    <option value="all" {% if status_filter=='all' %}selected{% endif %}>å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="active" {% if status_filter=='active' %}selected{% endif %}>ğŸŸ¢ æ´»èº</option>
                    <option value="low" {% if status_filter=='low' %}selected{% endif %}>ğŸŸ¡ ä½å„ªå…ˆ</option>
                    <option value="frozen" {% if status_filter=='frozen' %}selected{% endif %}>ğŸ”´ å‡çµ</option>
                </select>

                <input form="searchForm" type="text" name="q" placeholder="ğŸ” æœå°‹ ID æˆ–å‚™è¨»..." class="search-input"
                    style="border: none; padding: 0 0.5rem; width: 180px; font-size: 0.875rem; outline: none; height: 100%;"
                    autocomplete="off" value="{{ search_query }}">

                {% if search_query %}
                <a href="{{ url_for('admin.index', group_id=active_group.group_id) }}" title="æ¸…é™¤æœå°‹"
                    style="padding: 0 0.5rem; color: #999; text-decoration: none; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; height: 100%; border-left: 1px solid #eee;">
                    âŒ
                </a>
                {% endif %}

                <button type="submit" form="searchForm" id="searchSubmitBtn" title="é–‹å§‹æœå°‹"
                    style="border: none; background: #f8f9fa; border-left: 1px solid var(--surface-border); cursor: pointer; padding: 0 0.6rem; height: 100%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                    ğŸ”
                </button>
            </div>

            <div class="btn-group">
                <!-- Mobile Select All Trigger (Persistent) -->
                <button type="button" class="btn btn-outline-secondary btn-sm mobile-only"
                    onclick="window.toggleAllMobile(this)" title="å…¨é¸/å–æ¶ˆå…¨é¸">
                    â˜‘ å…¨é¸
                </button>

                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/export" formmethod="POST"
                    formtarget="_blank" class="btn btn-secondary btn-sm" title="åŒ¯å‡ºå®Œæ•´ Excel (ä¸å—æœå°‹å½±éŸ¿)">
                    ğŸ“¥ åŒ¯å‡º
                </button>
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/export-pdf" formmethod="POST"
                    class="btn btn-secondary btn-sm" title="åŒ¯å‡ºç‚º PDF">
                    ğŸ“„ PDF
                </button>
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/refresh" formmethod="POST"
                    class="btn btn-primary btn-sm desktop-only" title="æ›´æ–°å¿«å–">
                    ğŸ”„
                    <span class="desktop-only" style="display:inline;">æ›´æ–°</span>
                </button>

                <!-- Mobile Actions are now in Bottom Sheet -->
                <!-- Desktop Delete Button -->
                <button type="submit" form="deleteMultiForm" class="btn btn-danger btn-sm desktop-only"
                    onclick="return confirm('ç¢ºå®šåˆªé™¤é¸å–é …ç›®ï¼Ÿ')">
                    åˆªé™¤é¸å–
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Action Sheet -->
    <div id="bottomActionSheet" class="bottom-action-sheet mobile-only">
        <div class="sheet-content">
            <div class="selected-count">
                <span id="selectedCountDisplay">0</span>
                <span class="text-xs" style="opacity:0.8; margin-left:2px;">ç­†å·²é¸å–</span>
            </div>
            <div class="sheet-actions">
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAllMobile(this)"
                    id="mobileSelectAllBtn">å…¨é¸</button>
                <!-- Refresh moved to bottom sheet -->
                <button type="submit" form="deleteMultiForm" formaction="/admin/threads/refresh" formmethod="POST"
                    class="btn btn-secondary btn-sm" onclick="return confirm('ç¢ºå®šæ›´æ–°é¸å–é …ç›®çš„å¿«å–ï¼Ÿ')" title="æ›´æ–°">
                    ğŸ”„
                </button>
                <button type="submit" form="deleteMultiForm" class="btn btn-danger btn-sm"
                    onclick="return confirm('ç¢ºå®šåˆªé™¤é¸å–é …ç›®ï¼Ÿ')">
                    ğŸ—‘ï¸ åˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <!-- Smart Select All Banner -->
    <div id="selectAllBanner" data-total="{{ total_threads_count }}" data-page-count="{{ threads|length }}"
        style="display: none; background: #e8f0fe; color: #1967d2; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid #d2e3fc;">
        <span id="selectAllBannerText">å·²é¸å–æœ¬é æ‰€æœ‰é …ç›®ã€‚</span>
        <a href="javascript:void(0)" onclick="selectAllAcrossPages()"
            style="font-weight: bold; text-decoration: underline; margin-left: 8px;">
            é¸å– Project ä¸­çš„å…¨éƒ¨ {{ total_threads_count }} ç­†è³‡æ–™
        </a>
        <span id="allSelectedMsg" style="display: none; font-weight: bold;">å·²é¸å– Project ä¸­çš„å…¨éƒ¨ {{
            total_threads_count
            }} ç­†è³‡æ–™ã€‚</span>
        <a href="javascript:void(0)" id="clearSelectionLink" onclick="clearSelection()"
            style="margin-left: 8px; font-size: 0.9em; display: none;">(æ¸…é™¤é¸å–)</a>

        <div style="margin-top: 4px; font-size: 0.85em; opacity: 0.8;">
            ğŸ’¡ æç¤ºï¼šæ‰¹æ¬¡æ“ä½œå°‡ä½œç”¨æ–¼æ‰€æœ‰ç¬¦åˆç•¶å‰æœå°‹æ¢ä»¶çš„è³‡æ–™ (å«æ‰€æœ‰åˆ†é )ã€‚
        </div>
    </div>

    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="thread-list-table">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="masterCheckbox"
                            onclick="toggleThreadListSelection(this)">
                    </th>
                    <th style="width: 40px; text-align: center;">â­</th>
                    <th>Thread ID</th>
                    <th>å‚™è¨»</th>
                    <th style="width: 100px;">
                        ç‹€æ…‹
                    </th>
                    <th style="width: 80px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for thread in threads %}
                <tr>
                    <td><input type="checkbox" form="deleteMultiForm" name="selected_ids" value="{{ thread.thread_id }}"
                            class="thread-checkbox" onclick="checkSelectionState()"></td>

                    <!-- Star Toggle -->
                    <td style="text-align: center; cursor: pointer;"
                        onclick="toggleBookmark(this, '{{ thread.thread_id }}', event)">
                        <span class="star-icon {% if thread.thread_id in bookmarked_ids %}active{% endif %}"
                            style="font-size: 1.2rem; line-height: 1; transition: transform 0.1s;">
                            {% if thread.thread_id in bookmarked_ids %}â˜…{% else %}â˜†{% endif %}
                        </span>
                    </td>

                    <td data-label="Thread ID" class="font-medium text-main">{{ thread.thread_id }}</td>
                    <td data-label="å‚™è¨»" class="editable-remark" data-thread-id="{{ thread.thread_id }}"
                        data-group-id="{{ active_group.group_id }}" style="cursor: pointer;" title="é»æ“Šç·¨è¼¯">
                        {{ thread.remark or 'âœï¸' }}
                    </td>
                    <td data-label="ç‹€æ…‹" style="text-align: center;">
                        {% if thread.refresh_priority == 'frozen' %}
                        <span title="å·²å‡çµï¼šé€£çºŒ {{ thread.stale_refresh_count }} æ¬¡ç„¡è®ŠåŒ–">ğŸ”´</span>
                        {% elif thread.refresh_priority == 'low' %}
                        <span title="ä½å„ªå…ˆç´šï¼šé€£çºŒ {{ thread.stale_refresh_count }} æ¬¡ç„¡è®ŠåŒ–">ğŸŸ¡</span>
                        {% else %}
                        <span title="æ´»èºä¸­">ğŸŸ¢</span>
                        {% endif %}
                    </td>
                    <td data-label="æ“ä½œ">
                        <a href="/admin/threads/view/{{ thread.thread_id }}?group_id={{ active_group.group_id }}"
                            class="btn btn-secondary btn-sm"
                            style="padding: 0.25rem 0.5rem; margin-right: 0.25rem; text-decoration: none;" title="æŸ¥çœ‹å°è©±">
                            ğŸ‘ï¸
                        </a>
                        <button type="submit" form="deleteMultiForm" formaction="/admin/threads/delete_multi"
                            name="thread_id" value="{{ thread.thread_id }}" class="btn btn-danger btn-sm"
                            style="padding: 0.25rem 0.5rem;" onclick="return confirm('åˆªé™¤ï¼Ÿ')">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        æ²’æœ‰è³‡æ–™
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    {% if threads_pagination and threads_pagination.pages > 1 %}
    <div class="flex items-center justify-between"
        style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-border);">
        <div class="text-sm text-secondary">
            é¡¯ç¤º {{ threads_pagination.items|length }} ç­† (å…± {{ total_threads_count }} ç­†)
        </div>
        <div class="flex gap-1" style="display:flex; gap:0.5rem;">
            {% if threads_pagination.has_prev %}
            <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.prev_num, q=search_query if search_query else None) }}"
                class="btn btn-secondary btn-sm">â€¹ ä¸Šä¸€é </a>
            {% endif %}

            <span class="btn btn-sm" style="background: transparent; border: 1px solid transparent; cursor: default;">
                é æ¬¡ {{ threads_pagination.page }} / {{ threads_pagination.pages }}
            </span>

            {% if threads_pagination.has_next %}
            <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.next_num, q=search_query if search_query else None) }}"
                class="btn btn-secondary btn-sm">ä¸‹ä¸€é  â€º</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    </form>

    <!-- Script moved to admin_list.js -->
</div>