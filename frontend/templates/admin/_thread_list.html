<!-- Thread List -->
<div class="card">
    <form action="/admin/threads/delete_multi" method="POST" id="deleteMultiForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="group_id" value="{{ active_group.group_id }}">

        <!-- Hidden input to toggle 'Select All Across Pages' mode -->
        <input type="hidden" name="select_all_pages" id="selectAllPagesInput" value="false">

        <div class="flex items-center justify-between mb-4" style="margin-bottom: 1rem;">
            <h3>clipboard è³‡æ–™åˆ—è¡¨ <span class="text-secondary text-sm" style="font-weight: normal; font-size: 0.8rem;">(å…±
                    {{ total_threads_count }} ç­†)</span></h3>
            <div class="flex gap-2">
                <input type="text" id="threadSearchInput" placeholder="ğŸ” æœå°‹ ID æˆ–å‚™è¨»..." class="input input-sm"
                    style="width: 180px; margin-right: 0.5rem;" autocomplete="off">

                <button type="submit" formaction="/admin/threads/export" formmethod="POST" formtarget="_blank"
                    class="btn btn-secondary btn-sm" title="åŒ¯å‡º Excel">
                    ğŸ“¥ åŒ¯å‡º
                </button>
                <button type="submit" formaction="/admin/threads/refresh" formmethod="POST"
                    class="btn btn-primary btn-sm" title="æ›´æ–°å¿«å–">
                    ğŸ”„ æ›´æ–°
                </button>
                <button type="button" class="btn btn-secondary btn-sm mobile-only" data-action="select"
                    onclick="toggleAllMobile(this)">
                    å…¨é¸
                </button>
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ç¢ºå®šåˆªé™¤é¸å–é …ç›®ï¼Ÿ')">
                    åˆªé™¤é¸å–
                </button>
            </div>
        </div>

        <!-- Smart Select All Banner -->
        <div id="selectAllBanner"
            style="display: none; background: #e8f0fe; color: #1967d2; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid #d2e3fc;">
            <span id="selectAllBannerText">å·²é¸å–æœ¬é æ‰€æœ‰é …ç›®ã€‚</span>
            <a href="javascript:void(0)" onclick="selectAllAcrossPages()"
                style="font-weight: bold; text-decoration: underline; margin-left: 8px;">
                é¸å– Project ä¸­çš„å…¨éƒ¨ {{ total_threads_count }} ç­†è³‡æ–™
            </a>
            <span id="allSelectedMsg" style="display: none; font-weight: bold;">å·²é¸å– Project ä¸­çš„å…¨éƒ¨ {{ total_threads_count
                }} ç­†è³‡æ–™ã€‚</span>
            <a href="javascript:void(0)" id="clearSelectionLink" onclick="clearSelection()"
                style="margin-left: 8px; font-size: 0.9em; display: none;">(æ¸…é™¤é¸å–)</a>
        </div>

        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="masterCheckbox" onclick="toggleAll(this)">
                        </th>
                        <th>Thread ID</th>
                        <th>å‚™è¨»</th>
                        <th style="width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for thread in threads %}
                    <tr>
                        <td><input type="checkbox" name="selected_ids" value="{{ thread.thread_id }}"
                                class="thread-checkbox" onclick="checkSelectionState()"></td>
                        <td data-label="Thread ID" class="font-medium text-main">{{ thread.thread_id }}</td>
                        <td data-label="å‚™è¨»" class="editable-remark" data-thread-id="{{ thread.thread_id }}"
                            data-group-id="{{ active_group.group_id }}" style="cursor: pointer;" title="é»æ“Šç·¨è¼¯">
                            {{ thread.remark or 'âœï¸' }}
                        </td>
                        <td data-label="æ“ä½œ">
                            <a href="/admin/threads/view/{{ thread.thread_id }}?group_id={{ active_group.group_id }}"
                                class="btn btn-secondary btn-sm"
                                style="padding: 0.25rem 0.5rem; margin-right: 0.25rem; text-decoration: none;"
                                title="æŸ¥çœ‹å°è©±">
                                ğŸ‘ï¸
                            </a>
                            <button type="submit" formaction="/admin/threads/delete_multi" name="thread_id"
                                value="{{ thread.thread_id }}" class="btn btn-danger btn-sm"
                                style="padding: 0.25rem 0.5rem;" onclick="return confirm('åˆªé™¤ï¼Ÿ')">
                                ğŸ—‘ï¸
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            æ²’æœ‰è³‡æ–™
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        {% if threads_pagination and threads_pagination.pages > 1 %}
        <div class="flex items-center justify-between"
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-border);">
            <div class="text-sm text-secondary">
                é¡¯ç¤º {{ threads_pagination.items|length }} ç­† (å…± {{ total_threads_count }} ç­†)
            </div>
            <div class="flex gap-1" style="display:flex; gap:0.5rem;">
                {% if threads_pagination.has_prev %}
                <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.prev_num) }}"
                    class="btn btn-secondary btn-sm">â€¹ ä¸Šä¸€é </a>
                {% endif %}

                <span class="btn btn-sm"
                    style="background: transparent; border: 1px solid transparent; cursor: default;">
                    é æ¬¡ {{ threads_pagination.page }} / {{ threads_pagination.pages }}
                </span>

                {% if threads_pagination.has_next %}
                <a href="{{ url_for('admin.index', group_id=active_group.group_id, t_page=threads_pagination.next_num) }}"
                    class="btn btn-secondary btn-sm">ä¸‹ä¸€é  â€º</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </form>

    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
            handleBannerVisibility(source.checked);
        }

        function toggleAllMobile(btn) {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            let allChecked = true;
            for (let c of checkboxes) { if (!c.checked) allChecked = false; }

            const newState = !allChecked;
            for (let c of checkboxes) { c.checked = newState; }

            const master = document.getElementById('masterCheckbox');
            if (master) master.checked = newState;

            handleBannerVisibility(newState);
        }

        function checkSelectionState() {
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            let allChecked = true;
            for (let c of checkboxes) { if (!c.checked) allChecked = false; }

            const master = document.getElementById('masterCheckbox');
            if (master) master.checked = allChecked;

            if (!allChecked) {
                clearSelection();
            } else {
                handleBannerVisibility(true);
            }
        }

        function handleBannerVisibility(isAllPageChecked) {
            const banner = document.getElementById('selectAllBanner');
            // Template vars injected by Jinja
            const total = {{ total_threads_count }
        };
        const onPage = {{ threads| length }};

        // Only show banner if there are more items than currently visible
        if (isAllPageChecked && total > onPage) {
            banner.style.display = 'block';
        } else {
            banner.style.display = 'none';
            clearSelection();
        }
        }

        function selectAllAcrossPages() {
            document.getElementById('selectAllPagesInput').value = 'true';
            document.getElementById('selectAllBannerText').style.display = 'none';
            document.querySelector('#selectAllBanner a[onclick^="selectAllAcrossPages"]').style.display = 'none';
            document.getElementById('allSelectedMsg').style.display = 'inline';
            document.getElementById('clearSelectionLink').style.display = 'inline';
        }

        function clearSelection() {
            document.getElementById('selectAllPagesInput').value = 'false';
            document.getElementById('selectAllBannerText').style.display = 'inline';
            const link = document.querySelector('#selectAllBanner a[onclick^="selectAllAcrossPages"]');
            if (link) link.style.display = 'inline';
            document.getElementById('allSelectedMsg').style.display = 'none';
            document.getElementById('clearSelectionLink').style.display = 'none';
        }
    </script>
</div>