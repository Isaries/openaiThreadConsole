{% extends "base.html" %}

{% block title %}ç³»çµ±æ•ˆèƒ½ç›£æ§ - Thread Console{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .kpi-card {
        background: var(--surface-bg);
        border: 1px solid var(--surface-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        flex: 1;
        min-width: 200px;
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .kpi-label {
        color: var(--secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .chart-container {
        background: white;
        border: 1px solid var(--surface-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-top: 1.5rem;
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
{% include "admin/_header.html" %}

<div class="container" style="padding: 2rem;">
    <div class="flex items-center justify-between mb-4">
        <h1>ğŸ“Š ç³»çµ±æ•ˆèƒ½ç›£æ§</h1>
        <div class="text-secondary text-sm">
            æœ€è¿‘æ›´æ–°: {{ current.time }}
            <button onclick="triggerRecalculate()" class="btn btn-sm btn-outline-secondary ml-2"
                title="é‡æ–°è¨ˆç®—æ‰€æœ‰è³‡æ–™çš„ Token (ä¿®å¾© 0 Token å•é¡Œ)">ğŸ› ï¸ ä¿®å¾© Token</button>
            <a href="/admin/performance" class="btn btn-sm btn-secondary ml-2">ğŸ”„ ç«‹å³åˆ·æ–°</a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="flex gap-4 flex-wrap">
        <div class="kpi-card">
            <div class="kpi-label">å³æ™‚ CPU ä½¿ç”¨ç‡</div>
            <div class="kpi-value {{ 'text-red' if current.cpu > 80 else 'text-green' }}">
                {{ current.cpu }}%
            </div>
            <div class="text-xs text-secondary">æ­£å¸¸ç¯„åœ &lt; 80%</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">å³æ™‚ RAM ä½¿ç”¨ç‡</div>
            <div class="kpi-value {{ 'text-red' if current.mem_pct > 85 else 'text-green' }}">
                {{ current.mem_pct }}%
            </div>
            <div class="text-xs text-secondary">{{ current.mem_gb }} GB / {{ mem_total }} GB</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">å·²ç®¡ç†è³‡æ–™é‡</div>
            <div class="kpi-value text-blue">
                {{ "{:,}".format(current.tokens) }}
            </div>
            <div class="text-xs text-secondary">Token æ•¸ (è³‡æ–™é‡æŒ‡æ¨™ï¼Œé API è²»ç”¨)</div>
        </div>
    </div>

    <!-- CPU Chart -->
    <div class="chart-container">
        <h3>CPU æ­·å²è¶¨å‹¢ (ç”±æ¯3å°æ™‚æ’ç¨‹ + å³æ™‚é»çµ„æˆ)</h3>
        <canvas id="cpuChart"></canvas>
    </div>

    <!-- Memory Chart -->
    <div class="chart-container">
        <h3>è¨˜æ†¶é«” æ­·å²è¶¨å‹¢</h3>
        <canvas id="memChart"></canvas>
    </div>

    <!-- Token Cumulative Chart -->
    <div class="chart-container">
        <h3>è³‡æ–™é‡ç´¯ç©è¶¨å‹¢ (Token ç¸½é‡)</h3>
        <p class="text-xs text-secondary mb-2">é¡¯ç¤ºç³»çµ±ç®¡ç†çš„ç¸½è³‡æ–™é‡æˆé•·è¶¨å‹¢</p>
        <canvas id="tokenCumulativeChart"></canvas>
    </div>

    <!-- Token Delta Chart -->
    <div class="chart-container">
        <h3>è³‡æ–™é‡å¢é‡è¶¨å‹¢ (æ–°å¢ Token æ•¸)</h3>
        <p class="text-xs text-secondary mb-2">é¡¯ç¤ºæ¯å€‹æ™‚é–“é»æ–°å¢çš„è³‡æ–™é‡ï¼Œå¯çœ‹å‡ºæ´»èºä½¿ç”¨æ™‚æ®µ</p>
        <canvas id="tokenDeltaChart"></canvas>
    </div>
</div>

<script id="perf-data" type="application/json">
    {{ chart_data | tojson }}
</script>
<script>
    const rawData = JSON.parse(document.getElementById('perf-data').textContent);

    const labels = rawData.map(d => d.time);
    const cpuData = rawData.map(d => d.cpu);
    const memData = rawData.map(d => d.mem_gb);
    const tokenData = rawData.map(d => d.tokens || 0);
    const tokenDeltaData = rawData.map(d => d.tokens_delta || 0);


    // Common Chart Options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        }
    };

    // CPU Chart
    new Chart(document.getElementById('cpuChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CPU Usage (%)',
                data: cpuData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.2,
                fill: true,
                pointRadius: (ctx) => {
                    // Make the last point (Real-time) larger
                    return ctx.dataIndex === rawData.length - 1 ? 6 : 3;
                },
                pointBackgroundColor: (ctx) => {
                    return ctx.dataIndex === rawData.length - 1 ? 'red' : 'rgb(75, 192, 192)';
                }
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    min: 0,
                    max: 100
                }
            }
        }
    });

    // Memory Chart
    new Chart(document.getElementById('memChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Memory Usage (GB)',
                data: memData,
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.2,
                fill: true,
                pointRadius: (ctx) => {
                    return ctx.dataIndex === rawData.length - 1 ? 6 : 3;
                },
                pointBackgroundColor: (ctx) => {
                    return ctx.dataIndex === rawData.length - 1 ? 'red' : 'rgb(153, 102, 255)';
                }
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    min: 0,
                    // Suggested Max slightly above total ram usually, but dynamic is fine
                }
            }
        }
    });


    // Token Cumulative Chart (Line)
    new Chart(document.getElementById('tokenCumulativeChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'ç´¯ç©è³‡æ–™é‡ (Tokens)',
                data: tokenData,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.2,
                fill: true,
                pointRadius: (ctx) => {
                    return ctx.dataIndex === rawData.length - 1 ? 6 : 3;
                },
                pointBackgroundColor: (ctx) => {
                    return ctx.dataIndex === rawData.length - 1 ? 'red' : 'rgb(54, 162, 235)';
                }
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    min: 0,
                    ticks: {
                        callback: function (value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('tokenDeltaChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'æ–°å¢è³‡æ–™é‡ (Tokens)',
                data: tokenDeltaData,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    min: 0,
                    ticks: {
                        callback: function (value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    function triggerRecalculate() {
        if (!confirm('ç¢ºå®šè¦é‡æ–°è¨ˆç®—æ‰€æœ‰è³‡æ–™çš„ Token å—ï¼Ÿé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚')) return;

        fetch('/admin/performance/recalculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() }}"
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('å·²å•Ÿå‹•é‡æ–°è¨ˆç®—ä»»å‹™ï¼Œè«‹ç¨å¾Œåˆ·æ–°é é¢æŸ¥çœ‹çµæœã€‚');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(e => alert('Connection Error'));
    }
</script>
{% endblock %}