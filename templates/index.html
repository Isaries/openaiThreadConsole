<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thread æœå°‹ç³»çµ±</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="auth-layout">

    <!-- Glassmorphism Orbs (Hidden unless theme active) -->
    <div class="orb-1"></div>
    <div class="orb-2"></div>

    <!-- Theme Switcher (Floating Bottom Left) -->
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 100; display: flex; align-items: center; gap: 8px;">
        <select id="themeSelect" class="select"
            style="padding: 0.25rem 0.5rem; font-size: 0.85rem; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: #333; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(5px);">
            <option value="bg-default">Default</option>
            <option value="bg-aurora">Aurora</option>
            <option value="bg-grid">Grid</option>
            <option value="bg-glass">Glass</option>
            <option value="bg-white">White</option>
        </select>
    </div>

    <div class="card auth-card">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1
                style="font-size: 1.75rem; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                ğŸ” Thread æœå°‹</h1>
            <p class="text-secondary text-sm" style="margin-top: 0.5rem;">æœå°‹åŒ…å«ç‰¹å®šé—œéµå­—çš„å°è©±ç´€éŒ„</p>
        </div>

        <form method="POST" action="/search" id="searchForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <div class="form-group">
                <label for="group_id">Project (å¿…å¡«)</label>
                <select id="group_id" name="group_id" class="select" required>
                    {% for group in groups %}
                    <option value="{{ group.group_id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="target_name">æœå°‹é—œéµå­—</label>
                <input type="text" id="target_name" name="target_name" class="input" placeholder="ä¾‹å¦‚: å§“åã€ä¸»é¡Œ..."
                    maxlength="50" autofocus>
            </div>

            <div class="form-group">
                <label>æ—¥æœŸç¯„åœ (é¸å¡«)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="date" id="start_date" name="start_date" class="input" placeholder="é–‹å§‹æ—¥æœŸ">
                    <input type="date" id="end_date" name="end_date" class="input" placeholder="çµæŸæ—¥æœŸ">
                </div>

                <div id="dateInfo" class="alert"
                    style="margin-top: 10px; display: block; padding: 0.75rem; background: var(--surface-bg); text-align: center; color: var(--text-secondary); border:none;">
                    ğŸ’¡ è«‹å¡«å¯«ã€Œé—œéµå­—ã€æˆ–ã€Œæ—¥æœŸã€
                </div>
            </div>

            <div id="errorMessage" class="alert alert-error" style="display: none;">
                âš ï¸ è«‹è‡³å°‘å¡«å¯«ã€Œé—œéµå­—ã€æˆ–ã€Œæ—¥æœŸã€å…¶ä¸­ä¸€é …!
            </div>

            <button type="submit" class="btn btn-primary btn-block" style="padding: 0.75rem; font-size: 1rem;">
                é–‹å§‹æœå°‹
            </button>
        </form>

        <div id="loading" style="display: none; text-align: center; margin-top: 1.5rem;">
            <div
                style="border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;">
            </div>
            <p class="text-secondary text-sm" style="margin-top: 0.5rem;">æœå°‹ä¸­...</p>
        </div>

        <div
            style="text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--surface-border);">
            <a href="/admin" class="btn btn-secondary btn-sm"
                style="display: inline-flex; color: var(--text-secondary); border: none; background: transparent;">
                âš™ï¸ ç®¡ç†å“¡ç™»å…¥
            </a>
        </div>
    </div>

    <!-- GitHub Avatar Link -->
    <a href="https://github.com/Isaries" target="_blank"
        style="position: fixed; bottom: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; overflow: hidden; box-shadow: var(--shadow-lg); border: 2px solid white; transition: transform 0.2s; z-index: 100;">
        <img src="https://github.com/Isaries.png" alt="Leo" style="width: 100%; height: 100%; object-fit: cover;">
    </a>

    <script>
        const form = document.getElementById('searchForm');
        const loading = document.getElementById('loading');
        const btn = document.querySelector('button[type="submit"]');
        const targetName = document.getElementById('target_name');
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        const dateInfo = document.getElementById('dateInfo');
        const errorMessage = document.getElementById('errorMessage');
        const groupIdSelect = document.getElementById('group_id');
        const themeSelect = document.getElementById('themeSelect');
        const body = document.body;

        // --- Theme Logic ---
        function applyTheme(theme) {
            // Remove all known theme classes
            body.classList.remove('bg-default', 'bg-aurora', 'bg-grid', 'bg-glass');
            // Add selected theme
            body.classList.add(theme);
            themeSelect.value = theme;
            localStorage.setItem('threadConsole_theme', theme);

            // Adjust card transparency for themes
            const card = document.querySelector('.auth-card');
            if (theme === 'bg-default' || theme === 'bg-grid') {
                card.style.background = 'rgba(255, 255, 255, 0.95)';
            } else {
                card.style.background = 'rgba(255, 255, 255, 0.75)'; // More translucent for Aurora/Glass
            }
        }

        // Init Theme
        const savedTheme = localStorage.getItem('threadConsole_theme') || 'bg-default';
        applyTheme(savedTheme);

        themeSelect.addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });

        // Persistence for Group Select
        const savedGroup = localStorage.getItem('threadConsole_selectedGroup');
        if (savedGroup) {
            if (groupIdSelect.querySelector(`option[value="${savedGroup}"]`)) {
                groupIdSelect.value = savedGroup;
            }
        }
        groupIdSelect.addEventListener('change', function () {
            localStorage.setItem('threadConsole_selectedGroup', this.value);
        });

        // Date Logic
        function updateDateInfo() {
            const start = startDate.value;
            const end = endDate.value;

            if (start && end) {
                if (start > end) {
                    dateInfo.innerText = 'âš ï¸ çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ';
                    dateInfo.className = 'alert alert-warning';
                } else if (start === end) {
                    dateInfo.innerText = 'ğŸ“… æœå°‹å–®ä¸€æ—¥æœŸ: ' + start;
                    dateInfo.className = 'alert alert-success';
                } else {
                    dateInfo.innerText = 'ğŸ“… æœå°‹ç¯„åœ: ' + start + ' è‡³ ' + end;
                    dateInfo.className = 'alert alert-success';
                }
            } else if (start || end) {
                const date = start || end;
                const type = start ? 'ä¹‹å¾Œ' : 'ä¹‹å‰';
                dateInfo.innerText = `ğŸ“… æœå°‹ ${date} ${type}çš„ç´€éŒ„`;
                dateInfo.className = 'alert badge-gray';
            } else {
                dateInfo.innerText = 'ğŸ’¡ è«‹å¡«å¯«ã€Œé—œéµå­—ã€æˆ–ã€Œæ—¥æœŸã€';
                dateInfo.className = 'alert badge-gray';
                dateInfo.style.background = 'var(--surface-bg)';
            }
            dateInfo.style.display = 'block';
        }

        startDate.addEventListener('change', () => {
            if (startDate.value && !endDate.value) endDate.value = startDate.value;
            updateDateInfo();
            errorMessage.style.display = 'none';
        });

        endDate.addEventListener('change', () => {
            if (endDate.value && !startDate.value) startDate.value = endDate.value;
            updateDateInfo();
            errorMessage.style.display = 'none';
        });

        targetName.addEventListener('input', () => {
            if (targetName.value.trim()) errorMessage.style.display = 'none';
        });

        form.addEventListener('submit', (e) => {
            const keyword = targetName.value.trim();
            const start = startDate.value;
            const end = endDate.value;

            if (!keyword && !start && !end) {
                e.preventDefault();
                errorMessage.style.display = 'block';
                return false;
            }

            if (start && end && start > end) {
                e.preventDefault();
                alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
                return false;
            }

            errorMessage.style.display = 'none';
            loading.style.display = 'block';
            btn.disabled = true;
            btn.innerText = 'æœå°‹ä¸­...';
        });

        window.addEventListener('pageshow', (event) => {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                loading.style.display = 'none';
                btn.disabled = false;
                btn.innerText = 'é–‹å§‹æœå°‹';
                errorMessage.style.display = 'none';
            }
        });

        // Spin Animation Keyframes need to be injected or in CSS
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(styleSheet);
    </script>
</body>

</html>